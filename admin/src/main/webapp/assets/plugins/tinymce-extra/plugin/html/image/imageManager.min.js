var options=top.tinymce.activeEditor.windowManager.getParams().options,tinymceId=top.tinymce.activeEditor.windowManager.getParams().id,commander=new TinyMCEExtra(options).imageCommander,editor=top.tinymce.get(tinymceId),nextMarker=null,folder=null,selectedItemAll=[],selectedItemShow=[],contextMenuName=null,pending=!1;function winWidth(){return document.documentElement.clientWidth||document.body.clientWidth}function winHeight(){return document.documentElement.clientHeight||document.body.clientHeight}var menu=document.getElementById("menu");document.addEventListener("contextmenu",function(){menu.style.display="none"}),document.addEventListener("click",function(){menu.style.display="none"}),menu.addEventListener("click",function(e){e.cancelBubble=!0});var container_right=document.querySelector("#container_right"),item_container=document.querySelector("#item_container");function showmenu(e,t){var n,o;e.preventDefault(),e.stopPropagation(),contextMenuName=t,menu.style.display="block",n=e.clientX,o=e.clientY,n>=winWidth()-menu.offsetWidth&&(n=winWidth()-menu.offsetWidth),o>winHeight()-menu.offsetHeight&&(o=winHeight()-menu.offsetHeight),menu.style.left=n+"px",menu.style.top=o+"px"}function listFolders(){commander.listFolders().then(function(e){var t;t=null==folder?'<a class="nav-menu active"  href="javascript:void(0);" onclick="switchFolder(event,\'\');">全部图片</a>':'<a class="nav-menu"  href="javascript:void(0);" onclick="switchFolder(event,\'\');">全部图片</a>';for(var n=document.querySelector("#nav_template").innerHTML,o=0;o<e.length;o++){var l=n;l=(l=l.replace(/{{name}}/g,e[o].name)).replace(/{{prefix}}/g,e[o].prefix),t+=l=folder===e[o].name?l.replace(/{{active}}/g,"active"):l.replace(/{{active}}/g,"")}e.length<100&&(t+="<a class='create-folder-btn' href='javascript:void(0)' onclick='createFolder()'>+ 新建目录</a>"),document.querySelector("#nav").innerHTML=t,document.querySelector("#item_upload_input").disabled=!1,document.querySelector("#item_upload_input").multiple=options.allowMultipleImageUpload}).catch(function(e){editor.windowManager.alert("错误："+(e.hasOwnProperty("msg")?e.msg:e))})}function listItems(e){if(pending=!0,e){if(null==nextMarker)return}else nextMarker=null;commander.listFiles(folder,nextMarker).then(function(t){nextMarker=t.nextMarker;var n="";if(t.objects)for(var o=document.querySelector("#itemBox_template").innerHTML,l=0;l<t.objects.length;l++){var i=o;i=(i=(i=i.replace(/{{filename}}/g,t.objects[l].filename)).replace(/{{name}}/g,t.objects[l].name)).replace(/{{url}}/g,t.objects[l].url),selectedItemAll.indexOf(t.objects[l].name)>-1?(selectedItemShow.push(t.objects[l].name),i=i.replace(/{{checked}}/g,"checked")):i=i.replace(/{{checked}}/g,""),n+=i}e?item_container.innerHTML+=n:item_container.innerHTML=n,btnEnableCheck(),pending=!1}).catch(function(e){null!=folder?editor.windowManager.alert("错误："+(e.hasOwnProperty("msg")?e.msg:e)):item_container.innerHTML="",pending=!1})}function createFolder(){var e=editor.windowManager.open({title:"新建目录",body:{type:"textbox",name:"folder_name",label:"名称"},onsubmit:function(t){t.preventDefault(),commander.createFolder(t.data.folder_name).then(function(t){listFolders(),e.close(),e=void 0}).catch(function(e){editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e)})}})}function switchFolder(e,t){folder!==t&&(nextMarker=null,folder=t,document.querySelector(".nav-menu.active").setAttribute("class","nav-menu"),e.target.setAttribute("class","nav-menu active"),selectedItemShow=[],listItems())}function deleteFolder(){menu.style.display="none",commander.deleteFolder(contextMenuName).then(function(e){folder===contextMenuName&&(folder=null,listItems()),listFolders()}).catch(function(e){editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e)})}function uploadItem(e){var t=e.files,n=t.length,o=0;if(n>0){function l(e){commander.testFile(folder?folder+"/"+e.name:e.name).then(function(t){var l=function(){commander.uploadFile(e,folder).then(function(e){++o===n&&(nextMarker=null,hideOverlay(),listItems())}).catch(function(e){++o===n&&(nextMarker=null,hideOverlay(),listItems(),editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e))})};t?editor.windowManager.confirm("该目录下已存在同命文件("+e.name+")，是否覆盖？",function(e){e?l():++o===n&&hideOverlay()}):l()}).catch(function(e){editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e)})}showOverlay();for(let e=0;e<n;e++)l(t[e])}e.value=""}function toggleItem(e,t){var n=selectedItemAll.indexOf(t),o=selectedItemShow.indexOf(t);n>-1?selectedItemAll.splice(n,1):selectedItemAll.push(t),o>-1?(selectedItemShow.splice(o,1),e.setAttribute("class","item-box")):(selectedItemShow.push(t),e.setAttribute("class","item-box checked")),btnEnableCheck()}function deleteItems(){editor.windowManager.confirm("确定删除选中的图片吗？",function(e){e&&(showOverlay(),commander.deleteFiles(selectedItemShow).then(function(e){for(var t=0;t<selectedItemShow.length;t++){var n=selectedItemAll.indexOf(selectedItemShow[t]);selectedItemAll.splice(n,1)}selectedItemShow=[],listItems(),btnEnableCheck(),hideOverlay()}).catch(function(e){hideOverlay(),editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e)}))})}function insertItems(){for(var e=0;e<selectedItemAll.length;e++){var t=document.querySelector(".image[data-name='"+selectedItemAll[e]+"']").src;editor.execCommand("mceInsertContent",!1,'<img style="width:100%;max-width: 100%" src="'+t+'"/>')}editor.windowManager.close(this)}function showOverlay(){document.querySelector("#overlay").setAttribute("class","show")}function hideOverlay(){document.querySelector("#overlay").setAttribute("class","")}function btnEnableCheck(){document.querySelector("#deleteBtn").setAttribute("class",selectedItemShow.length>0?"show":""),document.querySelector("#submitBtn").disabled=0===selectedItemAll.length}function closeWin(){editor.windowManager.close(this)}container_right.onscroll=function(){var e=container_right.scrollTop,t=item_container.offsetHeight,n=container_right.clientHeight;!pending&&e>=t-n&&listItems(!0)},listFolders(),listItems();