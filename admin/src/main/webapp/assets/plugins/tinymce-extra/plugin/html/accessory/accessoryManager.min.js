var options=top.tinymce.activeEditor.windowManager.getParams().options,tinymceId=top.tinymce.activeEditor.windowManager.getParams().id,TinyMCEManagerPath=top.tinymce.activeEditor.windowManager.getParams().TinyMCEManagerPath,commander=new TinyMCEExtra(options).accessoryCommander,editor=top.tinymce.get(tinymceId),nextMarker=null,folder=null,selectedItemAll=[],selectedItemShow=[],contextMenuName=null,pending=!1;function winWidth(){return document.documentElement.clientWidth||document.body.clientWidth}function winHeight(){return document.documentElement.clientHeight||document.body.clientHeight}var menu=document.getElementById("menu");document.addEventListener("contextmenu",function(){menu.style.display="none"}),document.addEventListener("click",function(){menu.style.display="none"}),menu.addEventListener("click",function(e){e.cancelBubble=!0});var container_right=document.querySelector("#container_right"),item_container=document.querySelector("#item_container");function showmenu(e,t){var n,o;e.preventDefault(),e.stopPropagation(),contextMenuName=t,menu.style.display="block",n=e.clientX,o=e.clientY,n>=winWidth()-menu.offsetWidth&&(n=winWidth()-menu.offsetWidth),o>winHeight()-menu.offsetHeight&&(o=winHeight()-menu.offsetHeight),menu.style.left=n+"px",menu.style.top=o+"px"}function listFolders(){commander.listFolders().then(function(e){var t;t=null==folder?'<a class="nav-menu active"  href="javascript:void(0);" onclick="switchFolder(event,\'\');">全部附件</a>':'<a class="nav-menu"  href="javascript:void(0);" onclick="switchFolder(event,\'\');">全部附件</a>';for(var n=document.querySelector("#nav_template").innerHTML,o=0;o<e.length;o++){var a=n;a=(a=a.replace(/{{name}}/g,e[o].name)).replace(/{{prefix}}/g,e[o].prefix),t+=a=folder===e[o].name?a.replace(/{{active}}/g,"active"):a.replace(/{{active}}/g,"")}e.length<100&&(t+="<a class='create-folder-btn' href='javascript:void(0)' onclick='createFolder()'>+ 新建目录</a>"),document.querySelector("#nav").innerHTML=t,document.querySelector("#item_upload_input").disabled=!1}).catch(function(e){editor.windowManager.alert("错误："+(e.hasOwnProperty("msg")?e.msg:e))})}function listItems(e){if(pending=!0,e){if(null==nextMarker)return}else nextMarker=null;commander.listFiles(folder,nextMarker).then(function(t){nextMarker=t.nextMarker;var n="";if(t.objects)for(var o=document.querySelector("#itemBox_template").innerHTML,a=0;a<t.objects.length;a++){var r=o;r=r.replace(/{{filename}}/g,t.objects[a].filename).replace(/{{name}}/g,t.objects[a].name).replace(/{{source}}/g,t.objects[a].url),selectedItemAll.indexOf(t.objects[a].name)>-1?(selectedItemShow.push(t.objects[a].name),r=r.replace(/{{checked}}/g,"checked")):r=r.replace(/{{checked}}/g,""),n+=r}e?item_container.innerHTML+=n:item_container.innerHTML=n,btnEnableCheck(),pending=!1}).catch(function(e){null!=folder?editor.windowManager.alert("错误："+(e.hasOwnProperty("msg")?e.msg:e)):item_container.innerHTML="",pending=!1})}function createFolder(){var e=editor.windowManager.open({title:"新建目录",body:{type:"textbox",name:"folder_name",label:"名称"},onsubmit:function(t){t.preventDefault(),commander.createFolder(t.data.folder_name).then(function(t){listFolders(),e.close(),e=void 0}).catch(function(e){editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e)})}})}function switchFolder(e,t){folder!==t&&(nextMarker=null,folder=t,document.querySelector(".nav-menu.active").setAttribute("class","nav-menu"),e.target.setAttribute("class","nav-menu active"),selectedItemShow=[],listItems())}function deleteFolder(){menu.style.display="none",commander.deleteFolder(contextMenuName).then(function(e){folder===contextMenuName&&(folder=null,listItems()),listFolders()}).catch(function(e){editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e)})}function uploadItem(e){var t=e.files[0];t&&commander.testFile(folder?folder+"/"+t.name:t.name).then(function(e){var n=function(){showOverlay(),commander.uploadFile(t,folder).then(function(e){nextMarker=null,hideOverlay(),listItems()}).catch(function(e){hideOverlay(),editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e)})};e?editor.windowManager.confirm("该目录下已存在同命文件，是否覆盖？",function(e){e&&n()}):n()}).catch(function(e){editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e)}),e.value=""}function toggleItem(e,t){var n=selectedItemAll.indexOf(t),o=selectedItemShow.indexOf(t);n>-1?selectedItemAll.splice(n,1):selectedItemAll.push(t),o>-1?(selectedItemShow.splice(o,1),e.setAttribute("class","item-box")):(selectedItemShow.push(t),e.setAttribute("class","item-box checked")),btnEnableCheck()}function deleteItems(){editor.windowManager.confirm("确定删除选中的附件吗？",function(e){e&&(showOverlay(),commander.deleteFiles(selectedItemShow).then(function(e){for(var t=0;t<selectedItemShow.length;t++){var n=selectedItemAll.indexOf(selectedItemShow[t]);selectedItemAll.splice(n,1)}selectedItemShow=[],listItems(),btnEnableCheck(),hideOverlay()}).catch(function(e){hideOverlay(),editor.windowManager.alert(e.hasOwnProperty("msg")?e.msg:e)}))})}function insertItems(){for(var e=TinyMCEManagerPath+"/html/accessory",t=0,n=0;n<selectedItemAll.length;n++){var o=document.querySelector(".image[data-name='"+selectedItemAll[n]+"']");!function(n,o,a){commander.sizeFile(n).then(function(n){var r='<iframe style="border: none" data-type="accessory" data-custom="true" data-map="name,source,type,size" data-name="'+o+'" data-source="'+a+'" data-size="'+n+'" data-placeholder-src="'+e+'/_accessory.html" data-wrapper-style="width:100%;height:68px;position:relative;margin:0 auto" data-real-src="'+e+'/_accessory.html"></iframe><div></div>';editor.execCommand("mceInsertContent",!1,r),++t===selectedItemAll.length&&editor.windowManager.close(this)}).catch(function(e){console.log(e)})}(o.dataset.name,o.dataset.showName,o.dataset.source)}}function showOverlay(){document.querySelector("#overlay").setAttribute("class","show")}function hideOverlay(){document.querySelector("#overlay").setAttribute("class","")}function btnEnableCheck(){document.querySelector("#deleteBtn").setAttribute("class",selectedItemShow.length>0?"show":""),document.querySelector("#submitBtn").disabled=0===selectedItemAll.length}function closeWin(){editor.windowManager.close(this)}container_right.onscroll=function(){var e=container_right.scrollTop,t=item_container.offsetHeight,n=container_right.clientHeight;!pending&&e>=t-n&&listItems(!0)},listFolders(),listItems();